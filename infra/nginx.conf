events { worker_connections 1024; }

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  upstream backend  { server backend:8000; }
  upstream frontend { server frontend:3000; }

  server {
    listen 80;
    server_name yc16sprint.ru 51.250.26.27 localhost;
    client_max_body_size 10M;

    # ----- API → Django -----
    location /api/ {
      proxy_pass http://backend;

      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;

      # Пробрасываем Authorization как есть, куки режем (чтобы не словить CSRF/Session)
      proxy_set_header Authorization $http_authorization;
      proxy_set_header Cookie "";

      proxy_buffering off;
      proxy_max_temp_file_size 0;
    }

    # ----- admin → Django -----
    location /admin/ {
      proxy_pass http://backend;

      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;

      proxy_set_header Authorization $http_authorization;
      proxy_set_header Cookie "";
    }

    # ----- collectstatic + media -----
    location /backend_static/ { alias /app/static/; }
    location /media/          { alias /app/media/;  }

    # ----- фронт → proxy на http-server:3000 (SPA отдаёт index.html сам) -----
    location / {
      proxy_pass http://frontend;

      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
    }
  }
}