# Простой gateway: прокси к backend и к frontend(http-server)

# Бэкенд на gunicorn
upstream backend {
    server backend:8000;
}

# Фронтенд (http-server внутри контейнера frontend)
upstream frontend {
    server frontend:8000;
}

server {
    listen 80;
    server_tokens off;
    client_max_body_size 10M;

    # API -> Django
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
        proxy_buffering off;
        proxy_max_temp_file_size 0;
    }

    # Админка -> Django
    location /admin/ {
        proxy_pass http://backend;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;
    }

    # Cтатик/медиа Django — из томов
    location /static/ { alias /static/; }
    location /media/  { alias /media/;  }

    # Всё остальное — на фронтенд
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host       $host;
        proxy_cache_bypass          $http_upgrade;
    }
}
